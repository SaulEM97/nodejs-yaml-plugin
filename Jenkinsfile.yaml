pipeline:
  agent:
    docker:
      image: 'node:20-slim'
      args: '-u root'

  environment:
    NODE_ENV: production
    VERSION: '1.0.0'

  stages:
    - stage: 'Install Dependencies'
      steps:
        - echo: "Installing Node modules..."
        - sh: "npm install"

    - stage: 'Run Tests'
      steps:
        - echo: "Running tests..."
        - sh: "npm test"

    - stage: 'Build/Package'
      steps:
        - echo: "Running lint and build step..."
        - sh: "npm run lint"
        - sh: "npm run build"
        - sh: "tar -czvf my-app-${VERSION}.tar.gz dist/"

    - stage: 'Deploy to Staging'
      steps:
        - echo: "Deploying version ${VERSION} to staging..."
        - sh: "./deploy.sh staging"

    - stage: 'Deploy to Production'
      steps:
        - echo: "Deploying to production..."
        - sh: "./deploy.sh production"

  post:
    always:
      - echo: "Pipeline finished. Check status."
    success:
      - echo: "Deployment Successful!"
    failure:
      - echo: "Pipeline FAILED! Check console output for errors."
